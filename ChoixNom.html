<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Liste des joueurs</title>
    <link rel="stylesheet" href="style.css">
    <script>
	     var liste= ""
 // Fonction pour charger les noms depuis resultats.txt via PHP
        function chargerNoms() {
            fetch('listescores.php?action=get_names')
                .then(response => response.json())					
                .then(data => {					
					liste=data;
					const sidebar = document.getElementById('sidebar');
                    sidebar.innerHTML = ''; // Réinitialiser la liste					
                    data.forEach(nom => {
                        const playerDiv = document.createElement('div');
                        playerDiv.className = 'player';
                        playerDiv.textContent = nom;						
                        playerDiv.onclick = () => selectionnerNom(playerDiv);
                        sidebar.appendChild(playerDiv);
                    });
                })
                .catch(error => console.error('Erreur lors du chargement des noms :', error));
        }

        let nomSelectionne = null;

// fonction pour sélectionner un joueur
        function selectionnerNom(playerDiv) {
            document.querySelectorAll('.player').forEach(div => div.classList.remove('selected'));
            playerDiv.classList.add('selected');
            nomSelectionne = playerDiv.textContent;
        }

// Fonction pour valider la sélection et ouvrir la nouvelle fenêtre
        function validerSelection() {
            if (!nomSelectionne) {
                alert('Veuillez sélectionner un joueur dans la liste.');
                return;
            }
            // Ouvrir une nouvelle fenêtre avec le fichier ChoixFiche.html		
             localStorage.setItem("nomJoueur", nomSelectionne);             
             window.location.href = "ChoixFiche.html";				
        }

        window.onload = () => {
            chargerNoms();
			
        };
		
// Fonction pour gérer la saisie et l'enregistrement
        function saisirResultats() {
            const prenom = prompt("Entrez d'abord le prénom du joueur :");
					if (!prenom){exit};
			const nomf = prompt("Entrez le nom de famille du joueur :"); 
					if (!nomf){exit};
			const noms= nomf.trim()+" "+prenom.trim();
			const nom = noms.toUpperCase();			
            if (nom === null || nom.trim() === "") return; // Annulation ou saisie vide

            if (nom.length > 30) {
                alert("Le nom ne doit pas dépasser 30 caractères.");
                return saisirResultats(); // Recommencer
            }
			
			if (liste.includes(nom)){
				alert("le nom "+nom+" est déjà dans la liste.");
				return saisirResultats();
				}
				
			if (nom=="LE NOM SUPPRIMER"){				
			boutonsup.style.display="inline";
			exit;}
				
			var dialog = confirm("Le nom "+nom+" va être ajouté à la liste");
				if (!dialog) {
				exit;}
				
			// Valeurs fantômes (qui ne seront pas enregistrées) pour permettre l'exécution de la fonction
			const indexFiche="65";			
			const score="5";
			const date="18/12/2024";
			envoyerDonnees(nom,indexFiche, score, date);
			chargerNoms();		
		}
		  
// Fonction pour envoyer les données au fichier PHP
        function envoyerDonnees(nom, indexFiche, score, date) {         
			fetch('resultats.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: new URLSearchParams({
                    nom: nom,
                    indexFiche: indexFiche,
                    score: score,
                    date: date
                })
            })
            .then(response => response.json())        
          
        chargerNoms();
		}
		
// Fonction pour supprimer un nom et ses données
		function supprimerNom() {
    if (!nomSelectionne) {
        alert("Veuillez sélectionner un joueur à supprimer.");
        return;
    }
    if (!confirm("ATTENTION ! \n Vous allez supprimer le nom et tous ses résultats. \n\n Êtes-vous sûr de vouloir supprimer " + nomSelectionne + " ?")) {
        return;
    }
    fetch('listescores.php?action=delete_name', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: new URLSearchParams({ nom: nomSelectionne })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert("Le joueur " + nomSelectionne + " a été supprimé.");
            chargerNoms();
        } else {
            alert("Erreur lors de la suppression : " + data.error);
        }
    })
    .catch(error => console.error("Erreur lors de la suppression :", error));
}

    </script>
</head>
<body>
	
   <div id="main">
		<H1> Choix du joueur </H1><br><br><br>
        <h2>Sélectionnez un joueur dans la liste<br>Puis cliquez sur le bouton bleu pour valider.</h2><br><br>
        <p><b>Si le nom n'est pas dans la liste,<br> cliquez sur le bouton "Entrer un nouveau nom."</b></p>
		 <button id="bouton" onclick="saisirResultats()">&nbsp;&nbsp;Entrer un nouveau nom&nbsp;&nbsp;</button>
		 <button id="boutonsup" onclick="supprimerNom()">&nbsp;&nbsp;Supprimer le nom sélectionné&nbsp;&nbsp;</button>
    </div>
    <div id="sidebar">
        <h2>Liste des joueurs</h2>
    </div>
    <button id="validate-btn" onclick="validerSelection()">Valider</button>
	
	
</body>
</html>
